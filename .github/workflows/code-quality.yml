name: Code Quality & Security

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for sensitive files in commits
        run: |
          echo "üîç Checking for sensitive files..."

          # Check if sensitive files exist in tracked files
          SENSITIVE_FILES=$(git ls-files | grep -E '(^\.env$|credentials|\.bak$|\.backup$)' || true)

          if [ -n "$SENSITIVE_FILES" ]; then
            echo "‚ùå ERROR: Sensitive files found:"
            echo "$SENSITIVE_FILES"
            exit 1
          else
            echo "‚úÖ No sensitive files found in tracked files"
          fi

      - name: Verify .gitignore is complete
        run: |
          echo "üîç Verifying .gitignore..."

          # Check critical patterns are in .gitignore
          grep -q 'data/mysql/' .gitignore || { echo "‚ùå Missing: data/mysql/"; exit 1; }
          grep -q '\.env' .gitignore || { echo "‚ùå Missing: .env"; exit 1; }
          grep -q '\.wp-credentials' .gitignore || { echo "‚ùå Missing: .wp-credentials"; exit 1; }

          echo "‚úÖ .gitignore is properly configured"

      - name: Check for hardcoded credentials in code
        run: |
          echo "üîç Scanning for hardcoded credentials..."

          # Search for potential hardcoded passwords/keys
          FOUND=$(grep -r -i -E '(password|passwd|pwd|secret|api_key|apikey|token)[\s]*=[\s]*["\047][^"\047]{8,}["\047]' \
            --include="*.php" \
            --include="*.js" \
            --exclude-dir=node_modules \
            --exclude-dir=vendor \
            --exclude-dir=data \
            . || true)

          if [ -n "$FOUND" ]; then
            echo "‚ö†Ô∏è  WARNING: Potential hardcoded credentials found:"
            echo "$FOUND"
            echo ""
            echo "Please review these findings. If false positives, add to exclusion list."
          else
            echo "‚úÖ No hardcoded credentials detected"
          fi

  php-lint:
    name: PHP Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.1"
          coverage: none

      - name: PHP Syntax Check - Kadence Theme
        run: |
          echo "üîç Checking PHP syntax in Kadence theme..."

          if [ -f "data/wordpress/wp-content/themes/kadence/functions-custom.php" ]; then
            php -l data/wordpress/wp-content/themes/kadence/functions-custom.php
            echo "‚úÖ functions-custom.php syntax OK"
          else
            echo "‚ö†Ô∏è  functions-custom.php not found (might be new repo)"
          fi

      - name: PHP Syntax Check - Custom Plugins
        run: |
          echo "üîç Checking PHP syntax in custom plugins..."

          if [ -d "data/wordpress/wp-content/plugins/jewelry-custom" ]; then
            find data/wordpress/wp-content/plugins/jewelry-custom -name "*.php" -exec php -l {} \;
            echo "‚úÖ All custom plugin files syntax OK"
          else
            echo "‚ö†Ô∏è  No custom plugins found yet"
          fi

      - name: PHP Syntax Check - Scripts
        run: |
          echo "üîç Checking PHP syntax in scripts..."

          find scripts -name "*.php" -exec php -l {} \; 2>/dev/null || echo "No PHP files in scripts/"

          echo "‚úÖ Scripts syntax check complete"

  php-tests:
    name: PHP Unit Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.1"
          extensions: mysqli, pdo_mysql, mbstring, intl
          tools: phpunit
          coverage: none

      - name: Check for test files
        id: check-tests
        run: |
          if find tests/php -name "test-*.php" -o -name "Test*.php" 2>/dev/null | grep -q .; then
            echo "has_tests=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ PHP test files found"
          else
            echo "has_tests=false" >> "$GITHUB_OUTPUT"
            echo "‚ÑπÔ∏è No PHP test files found - skipping tests"
          fi

      - name: Install WordPress test suite
        if: steps.check-tests.outputs.has_tests == 'true'
        run: |
          mkdir -p /tmp/wordpress-tests-lib
          svn co --quiet https://develop.svn.wordpress.org/tags/6.9.1/tests/phpunit/includes/ /tmp/wordpress-tests-lib/includes
          svn co --quiet https://develop.svn.wordpress.org/tags/6.9.1/tests/phpunit/data/ /tmp/wordpress-tests-lib/data

      - name: Create wp-tests-config.php
        if: steps.check-tests.outputs.has_tests == 'true'
        run: |
          cat > /tmp/wordpress-tests-lib/wp-tests-config.php << 'EOF'
          <?php
          define( 'DB_NAME', 'wordpress_test' );
          define( 'DB_USER', 'root' );
          define( 'DB_PASSWORD', 'root' );
          define( 'DB_HOST', '127.0.0.1' );
          define( 'DB_CHARSET', 'utf8' );
          define( 'DB_COLLATE', '' );
          define( 'WP_TESTS_DOMAIN', 'example.org' );
          define( 'WP_TESTS_EMAIL', 'admin@example.org' );
          define( 'WP_TESTS_TITLE', 'Test Blog' );
          define( 'WP_PHP_BINARY', 'php' );
          define( 'ABSPATH', '/tmp/wordpress/' );
          EOF

      - name: Run PHPUnit tests
        if: steps.check-tests.outputs.has_tests == 'true'
        run: |
          echo "Running PHP unit tests..."
          phpunit --configuration tests/php/phpunit.xml --testdox 2>/dev/null || \
          phpunit tests/php/ --testdox
        env:
          WP_TESTS_DIR: /tmp/wordpress-tests-lib

      - name: Tests skipped notice
        if: steps.check-tests.outputs.has_tests == 'false'
        run: |
          echo "‚ÑπÔ∏è No PHP tests found. Add tests under tests/php/ to enable this job."

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for E2E test files
        id: check-e2e
        run: |
          if find tests/e2e -name "*.spec.js" -o -name "*.spec.ts" 2>/dev/null | grep -q .; then
            echo "has_tests=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ E2E test files found"
          else
            echo "has_tests=false" >> "$GITHUB_OUTPUT"
            echo "‚ÑπÔ∏è No E2E test files found - skipping"
          fi

      - name: Setup Node.js
        if: steps.check-e2e.outputs.has_tests == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        if: steps.check-e2e.outputs.has_tests == 'true'
        run: |
          if [ -f "package.json" ]; then
            npm ci
          else
            npm init -y
            npm install @playwright/test
          fi

      - name: Install Playwright browsers
        if: steps.check-e2e.outputs.has_tests == 'true'
        run: npx playwright install --with-deps chromium

      - name: Start WordPress environment
        if: steps.check-e2e.outputs.has_tests == 'true'
        run: |
          docker compose -f .github/workflows/docker-compose.ci.yml up -d
          timeout 120 bash -c 'until curl -f http://localhost:8080/wp-admin/install.php; do sleep 2; done'

      - name: Run E2E tests
        if: steps.check-e2e.outputs.has_tests == 'true'
        run: npx playwright test tests/e2e/ --reporter=list
        env:
          BASE_URL: http://localhost:8080

      - name: Cleanup
        if: steps.check-e2e.outputs.has_tests == 'true' && always()
        run: docker compose -f .github/workflows/docker-compose.ci.yml down -v

      - name: E2E tests skipped notice
        if: steps.check-e2e.outputs.has_tests == 'false'
        run: |
          echo "‚ÑπÔ∏è No E2E tests found. Add tests under tests/e2e/ to enable this job."

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: |
            **/*.md
            !data/**
            !node_modules/**

  repo-structure:
    name: Repository Structure Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required files exist
        run: |
          echo "üîç Checking required files..."

          # Required files
          REQUIRED_FILES=(
            "README.md"
            "PROYECTO-ESTADO.md"
            ".gitignore"
            ".editorconfig"
            "docker-compose.yml"
            ".env.example"
          )

          MISSING=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING+=("$file")
            fi
          done

          if [ ${#MISSING[@]} -ne 0 ]; then
            echo "‚ùå Missing required files:"
            printf '%s\n' "${MISSING[@]}"
            exit 1
          else
            echo "‚úÖ All required files present"
          fi

      - name: Verify directory structure
        run: |
          echo "üîç Checking directory structure..."

          # Required directories
          REQUIRED_DIRS=(
            ".github"
            ".github/agents"
            ".ai-tools"
            "scripts"
            "docs"
          )

          MISSING=()
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ ! -d "$dir" ]; then
              MISSING+=("$dir")
            fi
          done

          if [ ${#MISSING[@]} -ne 0 ]; then
            echo "‚ùå Missing required directories:"
            printf '%s\n' "${MISSING[@]}"
            exit 1
          else
            echo "‚úÖ All required directories present"
          fi

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs:
      [
        security-audit,
        php-lint,
        php-tests,
        e2e-tests,
        markdown-lint,
        repo-structure,
      ]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "üìä CI/CD Summary"
          echo "================"
          echo ""
          echo "Security Audit: ${{ needs.security-audit.result }}"
          echo "PHP Lint: ${{ needs.php-lint.result }}"
           echo "PHP Tests: ${{ needs.php-tests.result }}"
           echo "E2E Tests: ${{ needs.e2e-tests.result }}"
          echo "Markdown Lint: ${{ needs.markdown-lint.result }}"
          echo "Repo Structure: ${{ needs.repo-structure.result }}"
          echo ""

          if [[ "${{ needs.security-audit.result }}" == "failure" ]] || \
             [[ "${{ needs.php-lint.result }}" == "failure" ]] || \
             [[ "${{ needs.php-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.e2e-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.markdown-lint.result }}" == "failure" ]] || \
             [[ "${{ needs.repo-structure.result }}" == "failure" ]]; then
            echo "‚ùå Some checks failed. Please review the logs above."
            exit 1
          else
            echo "‚úÖ All checks passed!"
          fi
